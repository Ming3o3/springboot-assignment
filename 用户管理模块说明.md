# 用户管理模块说明

## 模块概述

用户管理模块是一个仅供**管理员**使用的功能模块，提供完整的用户增删改查（CRUD）操作。普通用户无权访问此模块。

## 技术架构

### 分层设计

```
Controller层（UserManagementController）
    ↓
Service层（IUserService / UserServiceImpl）
    ↓
Mapper层（UserMapper / RoleMapper / UserRoleMapper）
    ↓
数据库（users / roles / user_roles）
```

### 代码文件结构

#### 1. DTO层
- **UserManageDTO.java** - 用户管理数据传输对象
  - 包含完整的参数验证注解
  - 支持创建和更新两种场景

#### 2. Service层
- **IUserService.java** - Service接口（已扩展）
  - getUserPage() - 分页查询用户
  - createUser() - 创建用户
  - updateUser() - 更新用户
  - deleteUser() - 删除单个用户
  - batchDeleteUsers() - 批量删除用户
  - getUserRoles() - 获取用户角色
  - updateUserRoles() - 更新用户角色

- **UserServiceImpl.java** - Service实现类（已扩展）
  - 实现所有Service接口方法
  - 包含事务管理
  - 参数验证和业务逻辑处理

#### 3. Controller层
- **UserManagementController.java** - 用户管理控制器
  - 使用 `@PreAuthorize("hasAuthority('ROLE_ADMIN')")` 进行权限控制
  - 提供页面访问和API接口两类方法

#### 4. 前端页面
- **manage.html** - 用户列表页面
  - 支持条件搜索（用户名、邮箱、状态）
  - 分页显示
  - 删除功能
  
- **add.html** - 添加用户页面
  - 表单验证
  - 角色分配
  
- **edit.html** - 编辑用户页面
  - 数据回显
  - 密码可选更新
  - 角色修改

## 功能特性

### 1. 权限控制
- ✅ 整个模块使用 `@PreAuthorize("hasAuthority('ROLE_ADMIN')")` 保护
- ✅ 只有拥有ROLE_ADMIN权限的用户可以访问
- ✅ 普通用户访问会返回403 Forbidden

### 2. 用户管理功能

#### 查询用户
- 分页列表显示
- 支持按用户名、邮箱、状态搜索
- 显示用户基本信息和创建时间

#### 添加用户
- 必填项：用户名、密码、邮箱、角色
- 可选项：真实姓名、手机号
- 自动密码加密（BCrypt）
- 用户名和邮箱唯一性验证

#### 编辑用户
- 修改用户基本信息
- 密码可选更新（留空不修改）
- 修改用户状态（启用/禁用）
- 修改用户角色

#### 删除用户
- 单个用户删除
- 批量删除（API支持）
- 级联删除用户角色关联

### 3. 角色管理
- 查看用户拥有的角色
- 分配/移除用户角色
- 支持多角色分配

### 4. 安全特性
- ✅ CSRF保护（前端请求携带token）
- ✅ 密码BCrypt加密
- ✅ 参数验证（JSR-303）
- ✅ 事务管理（@Transactional）
- ✅ 异常处理和错误提示

## API接口

### 用户列表
```
GET /user/api/list
参数：current, size, username, email, status
```

### 添加用户
```
POST /user/api/add
Body: UserManageDTO (JSON)
```

### 更新用户
```
PUT /user/api/update
Body: UserManageDTO (JSON)
```

### 删除用户
```
DELETE /user/api/delete/{id}
```

### 批量删除
```
DELETE /user/api/batch-delete
Body: Long[] (用户ID数组)
```

### 获取用户详情
```
GET /user/api/detail/{id}
```

### 获取所有角色
```
GET /user/api/roles
```

## 页面访问

### 用户管理首页
```
GET /user/manage
```

### 添加用户页面
```
GET /user/add
```

### 编辑用户页面
```
GET /user/edit/{id}
```

## 使用说明

### 1. 访问入口
- 管理员登录后，在导航栏会看到"用户管理"链接
- 点击进入用户管理页面

### 2. 搜索用户
- 在搜索框输入用户名、邮箱或选择状态
- 点击"搜索"按钮

### 3. 添加用户
- 点击"+ 新增用户"按钮
- 填写必填项（用户名、密码、邮箱）
- 至少选择一个角色
- 点击"提交"按钮

### 4. 编辑用户
- 在用户列表中点击"编辑"按钮
- 修改用户信息
- 如需修改密码，填写新密码；否则留空
- 点击"更新"按钮

### 5. 删除用户
- 在用户列表中点击"删除"按钮
- 确认删除操作
- 用户及其角色关联将被删除

## 代码规范

### 命名规范
- DTO类：`UserManageDTO`
- Service接口：`IUserService`
- Service实现：`UserServiceImpl`
- Controller：`UserManagementController`
- 方法命名：驼峰式，动词开头

### 注释规范
- 所有类都有JavaDoc注释
- 所有公共方法都有注释说明
- 复杂业务逻辑有行内注释

### 异常处理
- Service层抛出RuntimeException
- Controller层捕获并返回Result对象
- 前端显示友好的错误提示

### 事务管理
- 涉及多表操作的方法使用`@Transactional`
- rollbackFor = Exception.class

## 测试建议

1. **权限测试**
   - 用普通用户登录，验证无法访问用户管理
   - 用管理员登录，验证可以正常访问

2. **功能测试**
   - 添加用户（正常、用户名重复、邮箱重复）
   - 编辑用户（更新信息、修改密码、修改角色）
   - 删除用户（单个删除、批量删除）
   - 搜索功能（按各种条件搜索）

3. **安全测试**
   - 验证CSRF token
   - 验证密码加密存储
   - 验证输入参数验证

## 扩展建议

1. 添加用户导出功能（Excel）
2. 添加用户导入功能
3. 添加操作日志记录
4. 添加用户头像上传
5. 添加用户权限详细设置
