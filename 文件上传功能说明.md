 
 
  # æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ“ åŠŸèƒ½æ¦‚è¿°

å·²ä¸ºä½ çš„é¡¹ç›®æ·»åŠ äº†å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œæ”¯æŒæœ¬åœ°ä¸Šä¼ äº§å“å›¾ç‰‡ã€‚

---

## ğŸ¯ æ–°å¢æ–‡ä»¶æ¸…å•

### 1. é…ç½®ç±»
- **FileUploadConfig.java** - æ–‡ä»¶ä¸Šä¼ é…ç½®ç±»
  - é…ç½®ä¸Šä¼ è·¯å¾„ã€æ–‡ä»¶ç±»å‹ã€å¤§å°é™åˆ¶ç­‰
  
- **WebMvcConfig.java** - MVCé…ç½®ç±»
  - é…ç½®é™æ€èµ„æºæ˜ å°„ï¼Œä½¿ä¸Šä¼ çš„æ–‡ä»¶å¯é€šè¿‡URLè®¿é—®

### 2. Serviceå±‚
- **IFileUploadService.java** - æ–‡ä»¶ä¸Šä¼ æœåŠ¡æ¥å£
- **FileUploadServiceImpl.java** - æ–‡ä»¶ä¸Šä¼ æœåŠ¡å®ç°
  - æ–‡ä»¶æ ¡éªŒï¼ˆç±»å‹ã€å¤§å°ï¼‰
  - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  - æŒ‰æ—¥æœŸåˆ†ç›®å½•å­˜å‚¨
  - æ–‡ä»¶åˆ é™¤åŠŸèƒ½

### 3. Controllerå±‚
- **FileUploadController.java** - æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨
  - POST `/api/file/upload/product-image` - ä¸Šä¼ äº§å“å›¾ç‰‡
  - DELETE `/api/file/delete` - åˆ é™¤æ–‡ä»¶

### 4. é…ç½®æ–‡ä»¶
- **application.yml** - æ·»åŠ æ–‡ä»¶ä¸Šä¼ ç›¸å…³é…ç½®

---

## ğŸ”§ é…ç½®è¯´æ˜

### application.ymlé…ç½®

```yaml
# Springæ–‡ä»¶ä¸Šä¼ é…ç½®
spring:
  servlet:
    multipart:
      enabled: true          # å¯ç”¨æ–‡ä»¶ä¸Šä¼ 
      max-file-size: 5MB     # å•ä¸ªæ–‡ä»¶æœ€å¤§5MB
      max-request-size: 10MB # å•æ¬¡è¯·æ±‚æœ€å¤§10MB

# è‡ªå®šä¹‰æ–‡ä»¶ä¸Šä¼ é…ç½®
file:
  upload:
    path: uploads/                    # ä¸Šä¼ æ ¹ç›®å½•
    product-image-path: products/     # äº§å“å›¾ç‰‡å­ç›®å½•
    max-size: 5242880                 # 5MB
    allowed-types:                    # å…è®¸çš„å›¾ç‰‡ç±»å‹
      - image/jpeg
      - image/jpg
      - image/png
      - image/gif
      - image/webp
```

---

## ğŸ“‚ æ–‡ä»¶å­˜å‚¨ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â””â”€â”€ uploads/
    â””â”€â”€ products/
        â”œâ”€â”€ 2025/
        â”‚   â””â”€â”€ 12/
        â”‚       â””â”€â”€ 25/
        â”‚           â”œâ”€â”€ abc123def456.jpg
        â”‚           â””â”€â”€ xyz789uvw012.png
        â””â”€â”€ ...
```

**ç‰¹ç‚¹**ï¼š
- æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†ç›®å½•ï¼ˆå¹´/æœˆ/æ—¥ï¼‰
- æ–‡ä»¶åä½¿ç”¨UUIDï¼Œé¿å…é‡å¤
- ä¿ç•™åŸå§‹æ–‡ä»¶æ‰©å±•å

---

## ğŸš€ APIæ¥å£è¯´æ˜

### 1. ä¸Šä¼ äº§å“å›¾ç‰‡

**æ¥å£**: `POST /api/file/upload/product-image`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆROLE_ADMINï¼‰

**è¯·æ±‚ç±»å‹**: `multipart/form-data`

**è¯·æ±‚å‚æ•°**:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| file | File | æ˜¯ | å›¾ç‰‡æ–‡ä»¶ |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "å›¾ç‰‡ä¸Šä¼ æˆåŠŸ",
  "data": "/uploads/products/2025/12/25/abc123def456.jpg",
  "success": true
}
```

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹ï¼ˆåŸç”ŸJSï¼‰**:
```javascript
// 1. è·å–æ–‡ä»¶
const fileInput = document.getElementById('imageFile');
const file = fileInput.files[0];

// 2. åˆ›å»ºFormData
const formData = new FormData();
formData.append('file', file);

// 3. ä¸Šä¼ æ–‡ä»¶
fetch('/api/file/upload/product-image', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(result => {
    if (result.success) {
        console.log('ä¸Šä¼ æˆåŠŸï¼Œå›¾ç‰‡URL:', result.data);
        // å°†URLè®¾ç½®åˆ°è¡¨å•çš„imageUrlå­—æ®µ
        document.getElementById('imageUrl').value = result.data;
    } else {
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.message);
    }
});
```

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹ï¼ˆjQueryï¼‰**:
```javascript
$('#imageFile').change(function() {
    const formData = new FormData();
    formData.append('file', this.files[0]);
    
    $.ajax({
        url: '/api/file/upload/product-image',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(result) {
            if (result.success) {
                $('#imageUrl').val(result.data);
                alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.message);
            }
        }
    });
});
```

### 2. åˆ é™¤æ–‡ä»¶

**æ¥å£**: `DELETE /api/file/delete`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆROLE_ADMINï¼‰

**è¯·æ±‚å‚æ•°**:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| fileUrl | String | æ˜¯ | æ–‡ä»¶URL |

**ç¤ºä¾‹**: `/api/file/delete?fileUrl=/uploads/products/2025/12/25/abc123.jpg`

---

## ğŸ¨ å‰ç«¯HTMLä¿®æ”¹å»ºè®®

### åŸè¡¨å•ï¼ˆURLè¾“å…¥ï¼‰
```html
<div class="form-group">
    <label for="imageUrl">äº§å“å›¾ç‰‡URL</label>
    <input type="text" id="imageUrl" name="imageUrl" 
           placeholder="https://" class="form-control">
</div>
```

### ä¿®æ”¹åï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰
```html
<div class="form-group">
    <label for="imageFile">äº§å“å›¾ç‰‡</label>
    <input type="file" id="imageFile" accept="image/*" 
           class="form-control" onchange="uploadImage()">
    <input type="hidden" id="imageUrl" name="imageUrl">
    <div id="imagePreview" style="margin-top: 10px;"></div>
</div>

<script>
function uploadImage() {
    const fileInput = document.getElementById('imageFile');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
    document.getElementById('imagePreview').innerHTML = 
        '<p>ä¸Šä¼ ä¸­...</p>';
    
    // åˆ›å»ºFormData
    const formData = new FormData();
    formData.append('file', file);
    
    // ä¸Šä¼ æ–‡ä»¶
    fetch('/api/file/upload/product-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // ä¿å­˜URLåˆ°éšè—å­—æ®µ
            document.getElementById('imageUrl').value = result.data;
            
            // æ˜¾ç¤ºé¢„è§ˆå›¾
            document.getElementById('imagePreview').innerHTML = 
                `<img src="${result.data}" style="max-width: 200px; max-height: 200px;">`;
        } else {
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.message);
            document.getElementById('imagePreview').innerHTML = '';
        }
    })
    .catch(error => {
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
        document.getElementById('imagePreview').innerHTML = '';
    });
}
</script>
```

---

## âœ… æ–‡ä»¶æ ¡éªŒè§„åˆ™

1. **æ–‡ä»¶ç±»å‹é™åˆ¶**
   - ä»…æ”¯æŒå›¾ç‰‡ï¼šjpgã€jpegã€pngã€gifã€webp

2. **æ–‡ä»¶å¤§å°é™åˆ¶**
   - å•ä¸ªæ–‡ä»¶æœ€å¤§5MB

3. **æƒé™é™åˆ¶**
   - ä»…ç®¡ç†å‘˜ï¼ˆROLE_ADMINï¼‰å¯ä¸Šä¼ 

4. **è‡ªåŠ¨å¤„ç†**
   - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ˆUUIDï¼‰
   - è‡ªåŠ¨æŒ‰æ—¥æœŸåˆ†ç›®å½•å­˜å‚¨
   - è‡ªåŠ¨åˆ›å»ºç›®å½•ç»“æ„

---

## ğŸ” å®‰å…¨è¯´æ˜

1. **æƒé™æ§åˆ¶**
   - ä¸Šä¼ å’Œåˆ é™¤æ¥å£éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
   - ä½¿ç”¨`@PreAuthorize`æ³¨è§£è¿›è¡Œæƒé™éªŒè¯

2. **æ–‡ä»¶ç±»å‹éªŒè¯**
   - æ£€æŸ¥MIMEç±»å‹ï¼Œé˜²æ­¢ä¸Šä¼ æ¶æ„æ–‡ä»¶
   - ä»…å…è®¸å›¾ç‰‡æ ¼å¼

3. **æ–‡ä»¶å¤§å°é™åˆ¶**
   - é˜²æ­¢æ¶æ„å¤§æ–‡ä»¶ä¸Šä¼ 
   - ä¿æŠ¤æœåŠ¡å™¨å­˜å‚¨ç©ºé—´

---

## ğŸ“ å·¥ä½œæµç¨‹

### æ–°å¢äº§å“æ—¶çš„æ–‡ä»¶ä¸Šä¼ æµç¨‹

1. **ç”¨æˆ·é€‰æ‹©å›¾ç‰‡** â†’ è§¦å‘æ–‡ä»¶ä¸Šä¼ 
2. **å‰ç«¯ä¸Šä¼ ** â†’ POST `/api/file/upload/product-image`
3. **åç«¯å¤„ç†**:
   - æ ¡éªŒæ–‡ä»¶ç±»å‹å’Œå¤§å°
   - ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
   - ä¿å­˜åˆ°æœ¬åœ°ç›®å½•
   - è¿”å›è®¿é—®URL
4. **å‰ç«¯æ¥æ”¶URL** â†’ è®¾ç½®åˆ°è¡¨å•çš„`imageUrl`å­—æ®µ
5. **æäº¤äº§å“è¡¨å•** â†’ åŒ…å«å›¾ç‰‡URL
6. **ä¿å­˜åˆ°æ•°æ®åº“** â†’ Productå®ä½“çš„`imageUrl`å­—æ®µ

### å›¾ç‰‡è®¿é—®

ä¸Šä¼ åçš„å›¾ç‰‡å¯é€šè¿‡ä»¥ä¸‹URLç›´æ¥è®¿é—®ï¼š
```
http://localhost:8080/uploads/products/2025/12/25/abc123def456.jpg
```

---

## ğŸ¯ ä¼˜åŠ¿

âœ… **æœ¬åœ°å­˜å‚¨** - ä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡  
âœ… **è‡ªåŠ¨ç®¡ç†** - æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†ç›®å½•  
âœ… **å”¯ä¸€å‘½å** - UUIDé¿å…æ–‡ä»¶åå†²çª  
âœ… **å®‰å…¨æ ¡éªŒ** - ç±»å‹ã€å¤§å°ã€æƒé™ä¸‰é‡éªŒè¯  
âœ… **æ˜“äºæ‰©å±•** - é…ç½®åŒ–è®¾è®¡ï¼Œæ˜“äºè°ƒæ•´  
âœ… **æ”¯æŒåˆ é™¤** - å¯åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶  

---

## ğŸ”„ ä¸åŸæœ‰ä»£ç çš„å…¼å®¹æ€§

- âœ… ProductSaveRequestä»ä¿ç•™`imageUrl`å­—æ®µ
- âœ… åªæ˜¯å°†æ‰‹åŠ¨è¾“å…¥URLæ”¹ä¸ºä¸Šä¼ åè‡ªåŠ¨è·å–URL
- âœ… æ•°æ®åº“è¡¨ç»“æ„æ— éœ€ä¿®æ”¹
- âœ… Serviceå±‚å’ŒEntityå±‚æ— éœ€ä¿®æ”¹

---

**ç°åœ¨ä½ å¯ä»¥ä¿®æ”¹å‰ç«¯HTMLï¼Œå°†URLè¾“å…¥æ¡†æ”¹ä¸ºæ–‡ä»¶ä¸Šä¼ æŒ‰é’®å³å¯ï¼** ğŸ‰
